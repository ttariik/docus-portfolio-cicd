name: Preview Build

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  preview:
    name: Build Preview
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Create .env config file
        run: cp example.env .env
      
      - name: Build project
        run: pnpm build
      
      - name: Comment PR with build status
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const buildDir = './build';
            const buildExists = fs.existsSync(buildDir);
            
            if (buildExists) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '✅ **Build successful!**\n\nThe preview build was created successfully.'
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '❌ **Build failed!**\n\nPlease check the build logs.'
              });
            }
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: preview-build
          path: build/
          retention-days: 3

